<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pytorch | 阿源编程</title>
    <meta name="description" content="一个用于展示项目文档和个人笔记的web网站">
    <link rel="stylesheet" href="/assets/style.0982f719.css">
    <link rel="modulepreload" href="/assets/Home.d845b908.js">
    <link rel="modulepreload" href="/assets/app.a88d1aa8.js">
    <link rel="modulepreload" href="/assets/note_deep_learning_3_pytorh.md.a838a1da.lean.js">
    <link rel="modulepreload" href="/assets/app.a88d1aa8.js">
    <meta name="author" content="Vbenjs Team">
    <meta name="keywords" content="vben, vitejs, vite, ant-design-vue, vue">
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="keywords" content="vue vben admin docs">
    <link rel="icon" href="/favicon32.ico">
    <meta name="twitter:title" content="Pytorch | 阿源编程">
    <meta property="og:title" content="Pytorch | 阿源编程">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-552b951b><div class="sidebar-button" data-v-552b951b><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="阿源编程, back to home" data-v-552b951b data-v-ce8ff4a6><img class="logo" src="/logo64.png" alt="Logo" data-v-ce8ff4a6><!-- {{ $site.title }} --><text style="margin-top:-1px;" data-v-ce8ff4a6>阿源编程 | 官方文档</text></a><div class="flex-grow" data-v-552b951b></div><div class="nav" data-v-552b951b><nav class="nav-links" data-v-552b951b data-v-0cf770ed><!--[--><div class="item" data-v-0cf770ed><div class="nav-link" data-v-0cf770ed data-v-48f23096><a class="item" href="/guide/introduction" data-v-48f23096>首页 <!----></a></div></div><div class="item" data-v-0cf770ed><div class="nav-link" data-v-0cf770ed data-v-48f23096><a class="item" href="/project/index" data-v-48f23096>项目文档 <!----></a></div></div><div class="item" data-v-0cf770ed><div class="nav-dropdown-link" data-v-0cf770ed data-v-33970600><button class="button" data-v-33970600><span class="button-text" data-v-33970600>好玩的</span><span class="right button-arrow" data-v-33970600></span></button><ul class="dialog" data-v-33970600><!--[--><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/intresting/Project" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>开源项目</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/intresting/ChatGPT" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>ChatGpt</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/intresting/AI_talk" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>AI行业对话</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-0cf770ed><div class="nav-dropdown-link" data-v-0cf770ed data-v-33970600><button class="button" data-v-33970600><span class="button-text" data-v-33970600>科研笔记</span><span class="right button-arrow" data-v-33970600></span></button><ul class="dialog" data-v-33970600><!--[--><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/note/python/01_python_base" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>python基础</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/note/machine_learning/03_machine_base" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>机器学习</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item active" href="/note/deep_learning/3_pytorh" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>深度学习</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-0cf770ed><div class="nav-dropdown-link" data-v-0cf770ed data-v-33970600><button class="button" data-v-33970600><span class="button-text" data-v-33970600>精读论文</span><span class="right button-arrow" data-v-33970600></span></button><ul class="dialog" data-v-33970600><!--[--><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>Cv</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>NLP</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-0cf770ed><div class="nav-dropdown-link" data-v-0cf770ed data-v-33970600><button class="button" data-v-33970600><span class="button-text" data-v-33970600>相关链接</span><span class="right button-arrow" data-v-33970600></span></button><ul class="dialog" data-v-33970600><!--[--><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/other/see" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>在线预览</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item isExternal" href="https://gitee.com/clint_sfy/clint_doc" target="_blank" rel="noopener noreferrer" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>项目源码</span><span class="icon" data-v-d2247c54><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-d2247c54><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item isExternal" href="https://gitee.com/clint_sfy/clint_doc" target="_blank" rel="noopener noreferrer" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>文档源码</span><span class="icon" data-v-d2247c54><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-d2247c54><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item isExternal" href="https://gitee.com/clint_sfy/clint_doc/stargazers" target="_blank" rel="noopener noreferrer" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>点赞支持</span><span class="icon" data-v-d2247c54><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-d2247c54><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-0cf770ed><div class="nav-link" data-v-0cf770ed data-v-48f23096><a class="item" href="/other/donate" data-v-48f23096>赞助 <!----></a></div></div><!--]--><!----><!-- <div v-if="repo" class="item">
      <NavLink :item="repo" />
    </div> --></nav></div><div class="nav-icons" data-v-552b951b><div class="item" data-v-552b951b><button class="nav-btn" aria-label="Toggle Theme" data-v-552b951b><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveaspectratio="xMidYMid meet" viewbox="0 0 24 24" style="display:none;"><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938A7.999 7.999 0 0 0 4 12z" fill="currentColor"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveaspectratio="xMidYMid meet" viewbox="0 0 24 24" style=""><path d="M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05L3.515 4.93zM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414l-2.121-2.121zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414l2.121-2.121zM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414l2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z" fill="currentColor"></path></svg></button></div><div class="item" data-v-552b951b><a class="nav-btn" href="https://gitee.com/clint_sfy/clint_doc" target="_blank" aria-label="View GitHub Repo" data-v-552b951b><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveaspectratio="xMidYMid meet" viewbox="0 0 24 24" data-v-552b951b><path d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32 0 0 1-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 0 1 .676-1.883c.752.27 1.261.735 1.947 1.588c-.094-.117.34.427.433.539c.19.227.33.365.44.438c.204.137.587.196 1.15.14c.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292c-.218-.894-.185-1.975.302-3.192a1 1 0 0 1 .63-.582c.081-.024.127-.035.208-.047c.803-.123 1.937.17 3.415 1.096A11.731 11.731 0 0 1 12 3.315c.912 0 1.818.104 2.684.308c1.477-.933 2.613-1.226 3.422-1.096c.085.013.157.03.218.05a1 1 0 0 1 .616.58c.487 1.216.52 2.297.302 3.19c.691.936 1.058 2.045 1.058 3.293c0 3.757-1.674 5.665-4.642 6.392c.125.415.19.879.19 1.38a300.492 300.492 0 0 1-.012 2.716a1 1 0 0 1-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446l.005-.705c.005-.708.007-1.338.007-1.998c0-.697-.183-1.152-.425-1.36c-.661-.57-.326-1.655.54-1.752c2.967-.333 4.337-1.482 4.337-4.66c0-.955-.312-1.744-.913-2.404a1 1 0 0 1-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 0 1-.833.135A9.626 9.626 0 0 0 12 5.315c-.89 0-1.772.119-2.592.35a1 1 0 0 1-.83-.134c-.752-.507-1.374-.807-1.868-.947c-.144.653-.073 1.194.092 1.607a1 1 0 0 1-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66c.865.097 1.201 1.177.544 1.748c-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 0 1-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z" fill="currentColor"></path></svg></a></div></div><!--[--><!--]--></header><!--[--><aside class="sidebar" data-v-3e48a26e><nav class="nav-links nav" data-v-3e48a26e data-v-0cf770ed><!--[--><div class="item" data-v-0cf770ed><div class="nav-link" data-v-0cf770ed data-v-48f23096><a class="item" href="/guide/introduction" data-v-48f23096>首页 <!----></a></div></div><div class="item" data-v-0cf770ed><div class="nav-link" data-v-0cf770ed data-v-48f23096><a class="item" href="/project/index" data-v-48f23096>项目文档 <!----></a></div></div><div class="item" data-v-0cf770ed><div class="nav-dropdown-link" data-v-0cf770ed data-v-33970600><button class="button" data-v-33970600><span class="button-text" data-v-33970600>好玩的</span><span class="right button-arrow" data-v-33970600></span></button><ul class="dialog" data-v-33970600><!--[--><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/intresting/Project" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>开源项目</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/intresting/ChatGPT" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>ChatGpt</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/intresting/AI_talk" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>AI行业对话</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-0cf770ed><div class="nav-dropdown-link" data-v-0cf770ed data-v-33970600><button class="button" data-v-33970600><span class="button-text" data-v-33970600>科研笔记</span><span class="right button-arrow" data-v-33970600></span></button><ul class="dialog" data-v-33970600><!--[--><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/note/python/01_python_base" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>python基础</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/note/machine_learning/03_machine_base" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>机器学习</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item active" href="/note/deep_learning/3_pytorh" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>深度学习</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-0cf770ed><div class="nav-dropdown-link" data-v-0cf770ed data-v-33970600><button class="button" data-v-33970600><span class="button-text" data-v-33970600>精读论文</span><span class="right button-arrow" data-v-33970600></span></button><ul class="dialog" data-v-33970600><!--[--><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>Cv</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>NLP</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-0cf770ed><div class="nav-dropdown-link" data-v-0cf770ed data-v-33970600><button class="button" data-v-33970600><span class="button-text" data-v-33970600>相关链接</span><span class="right button-arrow" data-v-33970600></span></button><ul class="dialog" data-v-33970600><!--[--><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item" href="/other/see" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>在线预览</span><span class="icon" data-v-d2247c54><!----></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item isExternal" href="https://gitee.com/clint_sfy/clint_doc" target="_blank" rel="noopener noreferrer" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>项目源码</span><span class="icon" data-v-d2247c54><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-d2247c54><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item isExternal" href="https://gitee.com/clint_sfy/clint_doc" target="_blank" rel="noopener noreferrer" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>文档源码</span><span class="icon" data-v-d2247c54><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-d2247c54><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></span></a></div></li><li class="dialog-item" data-v-33970600><div class="nav-dropdown-link-item" data-v-33970600 data-v-d2247c54><a class="item isExternal" href="https://gitee.com/clint_sfy/clint_doc/stargazers" target="_blank" rel="noopener noreferrer" data-v-d2247c54><span class="arrow" data-v-d2247c54></span><span class="text" data-v-d2247c54>点赞支持</span><span class="icon" data-v-d2247c54><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-d2247c54><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-0cf770ed><div class="nav-link" data-v-0cf770ed data-v-48f23096><a class="item" href="/other/donate" data-v-48f23096>赞助 <!----></a></div></div><!--]--><!----><!-- <div v-if="repo" class="item">
      <NavLink :item="repo" />
    </div> --></nav><!--[--><!--]--><ul class="sidebar-links" data-v-3e48a26e><!--[--><li class="sidebar-link"><p class="sidebar-link-item">深度学习</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item active" href="/note/deep_learning/3_pytorh">1_pytorch</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-神经网络实战分类与回归任务">1. 神经网络实战分类与回归任务</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#mnist分类任务">Mnist分类任务</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#读取mnist数据集">读取Mnist数据集</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#torch-nn-functional-很多层和函数在这里都会见到">torch.nn.functional 很多层和函数在这里都会见到</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#创建一个model来更简化代码">创建一个model来更简化代码</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#使用tensordataset和dataloader来简化">使用TensorDataset和DataLoader来简化</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-利用pytorch神经网络进行气温预测">2. 利用pytorch神经网络进行气温预测</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-构建网络模型">1 构建网络模型</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-更简单的构建网络模型">2 更简单的构建网络模型</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-卷积神将网络参数解读">3. 卷积神将网络参数解读</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-构建卷积神经网络">1 构建卷积神经网络</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-首先读取数据">2 首先读取数据</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-卷积网络模块构建">3 卷积网络模块构建</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-准确率作为评估标准">4 准确率作为评估标准</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_5-训练网络模型">5 训练网络模型</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-图像识别模型与训练策略">4. 图像识别模型与训练策略</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-1-数据预处理部分：">1.0.1 数据预处理部分：</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-2-网络模块设置：">1.0.2 网络模块设置：</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-3-网络模型保存与测试">1.0.3 网络模型保存与测试</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-4-数据读取与预处理操作">1.0.4 数据读取与预处理操作</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-5-制作好数据源：">1.0.5 制作好数据源：</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-6-读取标签对应的实际名字">1.0.6 读取标签对应的实际名字</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-7-加载models中提供的模型">1.0.7 加载models中提供的模型</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-8-把模型输出层改成自己的">1.0.8 把模型输出层改成自己的</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-9-设置哪些层需要训练">1.0.9 设置哪些层需要训练</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-10-优化器设置">1.0.10 优化器设置</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-11-训练模块">1.0.11 训练模块</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-12-开始训练">1.0.12 开始训练</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-13-再继续训练所有层">1.0.13 再继续训练所有层</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-14-加载训练好的模型">1.0.14 加载训练好的模型</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-15-测试数据预处理">1.0.15 测试数据预处理</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-16-得到概率最大的那个">1.0.16 得到概率最大的那个</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-0-17-展示预测结果">1.0.17 展示预测结果</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_5-数据集dataloader制作">5.数据集Dataloader制作</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-1-如何自定义数据集：">1.1 如何自定义数据集：</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-2-咱们以花朵数据集为例：">1.2 咱们以花朵数据集为例：</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-0-1-任务1：读取txt文件中的路径和标签">2.0.1 任务1：读取txt文件中的路径和标签</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-0-2-任务2：分别把数据和标签都存在list里">2.0.2 任务2：分别把数据和标签都存在list里</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-0-3-任务3：图像数据路径得完整">2.0.3 任务3：图像数据路径得完整</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-0-4-任务4：把上面那几个事得写在一起">2.0.4 任务4：把上面那几个事得写在一起</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-0-5-任务5：数据预处理-transform">2.0.5 任务5：数据预处理(transform)</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-0-6-任务6：根据写好的class-flowerdataset-dataset-来实例化咱们的dataloader">2.0.6 任务6：根据写好的class FlowerDataset(Dataset):来实例化咱们的dataloader</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-0-7-任务7：用之前先试试，整个数据和标签对应下，看看对不对">2.0.7 任务7：用之前先试试，整个数据和标签对应下，看看对不对</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-0-8-任务8：咋用就是你来定了，把模型啥的整好往里面传吧">2.0.8 任务8：咋用就是你来定了，把模型啥的整好往里面传吧</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_6-lstm文本分类实战">6. LSTM文本分类实战</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_7-flask部署">7. flask部署</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/note/deep_learning/4_MMLab">2_mmlab</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><!-- <Slugs /> --><!--]--><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-4c107763><div class="container" data-v-4c107763><!--[--><!--]--><div class="content" data-v-4c107763><div data-v-4c107763><h1 id="pytorch"><a class="header-anchor" href="#pytorch" aria-hidden="true">#</a> Pytorch</h1><h2 id="_1-神经网络实战分类与回归任务"><a class="header-anchor" href="#_1-神经网络实战分类与回归任务" aria-hidden="true">#</a> 1. 神经网络实战分类与回归任务</h2><h3 id="mnist分类任务"><a class="header-anchor" href="#mnist分类任务" aria-hidden="true">#</a> Mnist分类任务</h3><ul><li>网络基本构建与训练方法，常用函数解析</li><li>torch.nn.functional模块</li><li>nn.Module模块</li></ul><h3 id="读取mnist数据集"><a class="header-anchor" href="#读取mnist数据集" aria-hidden="true">#</a> 读取Mnist数据集</h3><div class="language-python"><pre><code><span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path
<span class="token keyword">import</span> requests

DATA_PATH <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span>
PATH <span class="token operator">=</span> DATA_PATH <span class="token operator">/</span> <span class="token string">&quot;mnist&quot;</span>

PATH<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

URL <span class="token operator">=</span> <span class="token string">&quot;http://deeplearning.net/data/mnist/&quot;</span>
FILENAME <span class="token operator">=</span> <span class="token string">&quot;mnist.pkl.gz&quot;</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>PATH <span class="token operator">/</span> FILENAME<span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        content <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>URL <span class="token operator">+</span> FILENAME<span class="token punctuation">)</span><span class="token punctuation">.</span>content
        <span class="token punctuation">(</span>PATH <span class="token operator">/</span> FILENAME<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
        
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> gzip
<span class="token comment"># 784是mnist数据集每个样本的像素点个数</span>
<span class="token keyword">with</span> gzip<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PATH <span class="token operator">/</span> FILENAME<span class="token punctuation">)</span><span class="token punctuation">.</span>as_posix<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x_valid<span class="token punctuation">,</span> y_valid<span class="token punctuation">)</span><span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&quot;latin-1&quot;</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

pyplot<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>x_train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">&quot;gray&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x_train<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 注意数据需转换成tensor才能参与后续建模训练</span>
<span class="token keyword">import</span> torch
<span class="token comment"># torch 里面的结构不一样</span>
x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> x_valid<span class="token punctuation">,</span> y_valid <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span>
    torch<span class="token punctuation">.</span>tensor<span class="token punctuation">,</span> <span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> x_valid<span class="token punctuation">,</span> y_valid<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token comment"># n 样本个数  c 像素点（特征）个数</span>
n<span class="token punctuation">,</span> c <span class="token operator">=</span> x_train<span class="token punctuation">.</span>shape
x_train<span class="token punctuation">,</span> x_train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> y_train<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y_train<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x_train<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>y_train<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y_train<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="torch-nn-functional-很多层和函数在这里都会见到"><a class="header-anchor" href="#torch-nn-functional-很多层和函数在这里都会见到" aria-hidden="true">#</a> torch.nn.functional 很多层和函数在这里都会见到</h3><p>torch.nn.functional中有很多功能，后续会常用的。那什么时候使用nn.Module，什么时候使用nn.functional呢？一般情况下，如果模型有可学习的参数，最好用nn.Module，其他情况nn.functional相对更简单一些</p><div class="language-python"><pre><code><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token comment"># 损失函数  交叉熵cross_entropy</span>
loss_func <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy

<span class="token keyword">def</span> <span class="token function">model</span><span class="token punctuation">(</span>xb<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">## mm矩阵乘法   x*w+b</span>
    <span class="token keyword">return</span> xb<span class="token punctuation">.</span>mm<span class="token punctuation">(</span>weights<span class="token punctuation">)</span> <span class="token operator">+</span> bias
</code></pre></div><div class="language-python"><pre><code>bs <span class="token operator">=</span> <span class="token number">64</span>
xb <span class="token operator">=</span> x_train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>bs<span class="token punctuation">]</span>  <span class="token comment"># a mini-batch from x</span>
yb <span class="token operator">=</span> y_train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>bs<span class="token punctuation">]</span>
<span class="token comment"># 权重参数  随机初始化</span>
<span class="token comment"># [64 * 784] [784 * 10]</span>
weights <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">,</span>  requires_grad <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> 
bs <span class="token operator">=</span> <span class="token number">64</span>
bias <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># loss_func(预测值 ，标签)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>loss_func<span class="token punctuation">(</span>model<span class="token punctuation">(</span>xb<span class="token punctuation">)</span><span class="token punctuation">,</span> yb<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="创建一个model来更简化代码"><a class="header-anchor" href="#创建一个model来更简化代码" aria-hidden="true">#</a> 创建一个model来更简化代码</h3><div class="language-"><pre><code>必须继承nn.Module且在其构造函数中需调用nn.Module的构造函数
无需写反向传播函数，nn.Module能够利用autograd自动实现反向传播
Module中的可学习参数可以通过named_parameters()或者parameters()返回迭代器
</code></pre></div><div class="language-python"><pre><code><span class="token keyword">from</span> torch <span class="token keyword">import</span> nn

<span class="token keyword">class</span> <span class="token class-name">Mnist_NN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>hidden1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token comment"># 输入层 和 中间层1</span>
        self<span class="token punctuation">.</span>hidden2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token comment"># 中间层1 和 中间层2</span>
        self<span class="token punctuation">.</span>out  <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment"># 中间层2 和 输出层（10个类别）</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 前向传播 </span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidden1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidden2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>out<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
</code></pre></div><div class="language-python"><pre><code>net <span class="token operator">=</span> Mnist_NN<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span>
Mnist_NN<span class="token punctuation">(</span>
  <span class="token punctuation">(</span>hidden1<span class="token punctuation">)</span><span class="token punctuation">:</span> Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">784</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>hidden2<span class="token punctuation">)</span><span class="token punctuation">:</span> Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">:</span> Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># 可以打印我们定义好名字里的权重和偏置项</span>
<span class="token keyword">for</span> name<span class="token punctuation">,</span> parameter <span class="token keyword">in</span> net<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span>parameter<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
</code></pre></div><h3 id="使用tensordataset和dataloader来简化"><a class="header-anchor" href="#使用tensordataset和dataloader来简化" aria-hidden="true">#</a> 使用TensorDataset和DataLoader来简化</h3><div class="language-python"><pre><code><span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> TensorDataset
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader

train_ds <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
<span class="token comment"># batch_size 打包完数     shuffle 洗牌操作</span>
train_dl <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_ds<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>bs<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

valid_ds <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>x_valid<span class="token punctuation">,</span> y_valid<span class="token punctuation">)</span>
valid_dl <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>valid_ds<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>bs <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>train_ds<span class="token punctuation">,</span> valid_ds<span class="token punctuation">,</span> bs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        DataLoader<span class="token punctuation">(</span>train_ds<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>bs<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        DataLoader<span class="token punctuation">(</span>valid_ds<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>bs <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># 一般在训练模型时加上model.train()，这样会正常使用Batch Normalization和 Dropout</span>
<span class="token comment"># 测试的时候一般选择model.eval()，这样就不会使用Batch Normalization和 Dropout</span>
</code></pre></div><div class="language-python"><pre><code><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token comment"># steps迭代次数 ，model , loss_func , opt 优化器, train_dl 数据的打包器, valid_dl</span>
<span class="token keyword">def</span> <span class="token function">fit</span><span class="token punctuation">(</span>steps<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_func<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> train_dl<span class="token punctuation">,</span> valid_dl<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> xb<span class="token punctuation">,</span> yb <span class="token keyword">in</span> train_dl<span class="token punctuation">:</span>
            loss_batch<span class="token punctuation">(</span>model<span class="token punctuation">,</span> loss_func<span class="token punctuation">,</span> xb<span class="token punctuation">,</span> yb<span class="token punctuation">,</span> opt<span class="token punctuation">)</span>

        <span class="token comment"># 验证的模式  不更新权重</span>
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            losses<span class="token punctuation">,</span> nums <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>
                <span class="token operator">*</span><span class="token punctuation">[</span>loss_batch<span class="token punctuation">(</span>model<span class="token punctuation">,</span> loss_func<span class="token punctuation">,</span> xb<span class="token punctuation">,</span> yb<span class="token punctuation">)</span> <span class="token keyword">for</span> xb<span class="token punctuation">,</span> yb <span class="token keyword">in</span> valid_dl<span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
        val_loss <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>multiply<span class="token punctuation">(</span>losses<span class="token punctuation">,</span> nums<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;当前step:&#39;</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;验证集损失：&#39;</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>val_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token keyword">from</span> torch <span class="token keyword">import</span> optim
<span class="token keyword">def</span> <span class="token function">get_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> Mnist_NN<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> model<span class="token punctuation">,</span> optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span> <span class="token comment"># lr学习率</span>
<span class="token keyword">def</span> <span class="token function">loss_batch</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> loss_func<span class="token punctuation">,</span> xb<span class="token punctuation">,</span> yb<span class="token punctuation">,</span> opt<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    loss <span class="token operator">=</span> loss_func<span class="token punctuation">(</span>model<span class="token punctuation">(</span>xb<span class="token punctuation">)</span><span class="token punctuation">,</span> yb<span class="token punctuation">)</span>

    <span class="token keyword">if</span> opt <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 算梯度</span>
        opt<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment"># 沿着梯度更新</span>
        opt<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 清0</span>

    <span class="token keyword">return</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>xb<span class="token punctuation">)</span> <span class="token comment"># 损失 , 训练样本总数（要算平均）</span>
</code></pre></div><div class="language-python"><pre><code>train_dl<span class="token punctuation">,</span> valid_dl <span class="token operator">=</span> get_data<span class="token punctuation">(</span>train_ds<span class="token punctuation">,</span> valid_ds<span class="token punctuation">,</span> bs<span class="token punctuation">)</span>
model<span class="token punctuation">,</span> opt <span class="token operator">=</span> get_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
fit<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_func<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> train_dl<span class="token punctuation">,</span> valid_dl<span class="token punctuation">)</span>
</code></pre></div><h2 id="_2-利用pytorch神经网络进行气温预测"><a class="header-anchor" href="#_2-利用pytorch神经网络进行气温预测" aria-hidden="true">#</a> 2. 利用pytorch神经网络进行气温预测</h2><div class="language-python"><pre><code><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd 
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">import</span> warnings
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">&quot;ignore&quot;</span><span class="token punctuation">)</span>
<span class="token operator">%</span>matplotlib inline

features <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">&#39;temps.csv&#39;</span><span class="token punctuation">)</span>

<span class="token comment">#看看数据长什么样子</span>
features<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
	year	month	day	week	temp_2	temp_1	average	actual	friend
<span class="token number">0</span>	<span class="token number">2016</span>	<span class="token number">1</span>	<span class="token number">1</span>	Fri	<span class="token number">45</span>	<span class="token number">45</span>	<span class="token number">45.6</span>	<span class="token number">45</span>	<span class="token number">29</span>
<span class="token number">1</span>	<span class="token number">2016</span>	<span class="token number">1</span>	<span class="token number">2</span>	Sat	<span class="token number">44</span>	<span class="token number">45</span>	<span class="token number">45.7</span>	<span class="token number">44</span>	<span class="token number">61</span>
<span class="token number">2</span>	<span class="token number">2016</span>	<span class="token number">1</span>	<span class="token number">3</span>	Sun	<span class="token number">45</span>	<span class="token number">44</span>	<span class="token number">45.8</span>	<span class="token number">41</span>	<span class="token number">56</span>
</code></pre></div><div class="language-"><pre><code>数据表中:
year,moth,day,week分别表示的具体的时间
temp_2：前天的最高温度值
temp_1：昨天的最高温度值
average：在历史中，每年这一天的平均最高温度值
actual：这就是我们的标签值了，当天的真实最高温度
friend：这一列可能是凑热闹的，你的朋友猜测的可能值，咱们不管它就好了
</code></pre></div><div class="language-python"><pre><code><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;数据维度:&#39;</span><span class="token punctuation">,</span> features<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
数据维度<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">348</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 处理时间数据</span>
<span class="token keyword">import</span> datetime

<span class="token comment"># 分别得到年，月，日</span>
years <span class="token operator">=</span> features<span class="token punctuation">[</span><span class="token string">&#39;year&#39;</span><span class="token punctuation">]</span>
months <span class="token operator">=</span> features<span class="token punctuation">[</span><span class="token string">&#39;month&#39;</span><span class="token punctuation">]</span>
days <span class="token operator">=</span> features<span class="token punctuation">[</span><span class="token string">&#39;day&#39;</span><span class="token punctuation">]</span>

<span class="token comment"># datetime格式</span>
dates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;-&#39;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>month<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;-&#39;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> months<span class="token punctuation">,</span> days<span class="token punctuation">)</span><span class="token punctuation">]</span>
dates <span class="token operator">=</span> <span class="token punctuation">[</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">&#39;%Y-%m-%d&#39;</span><span class="token punctuation">)</span> <span class="token keyword">for</span> date <span class="token keyword">in</span> dates<span class="token punctuation">]</span>

dates<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 准备画图</span>
<span class="token comment"># 指定默认风格</span>
plt<span class="token punctuation">.</span>style<span class="token punctuation">.</span>use<span class="token punctuation">(</span><span class="token string">&#39;fivethirtyeight&#39;</span><span class="token punctuation">)</span>

<span class="token comment"># 设置布局</span>
fig<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ax1<span class="token punctuation">,</span> ax2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ax3<span class="token punctuation">,</span> ax4<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>nrows<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> ncols<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> figsize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>autofmt_xdate<span class="token punctuation">(</span>rotation <span class="token operator">=</span> <span class="token number">45</span><span class="token punctuation">)</span>

<span class="token comment"># 标签值</span>
ax1<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>dates<span class="token punctuation">,</span> features<span class="token punctuation">[</span><span class="token string">&#39;actual&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax1<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ax1<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">&#39;Temperature&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ax1<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">&#39;Max Temp&#39;</span><span class="token punctuation">)</span>

<span class="token comment"># 昨天</span>
ax2<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>dates<span class="token punctuation">,</span> features<span class="token punctuation">[</span><span class="token string">&#39;temp_1&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax2<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ax2<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">&#39;Temperature&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ax2<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">&#39;Previous Max Temp&#39;</span><span class="token punctuation">)</span>

<span class="token comment"># 前天</span>
ax3<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>dates<span class="token punctuation">,</span> features<span class="token punctuation">[</span><span class="token string">&#39;temp_2&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax3<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">&#39;Date&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ax3<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">&#39;Temperature&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ax3<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">&#39;Two Days Prior Max Temp&#39;</span><span class="token punctuation">)</span>

<span class="token comment"># 我的逗逼朋友</span>
ax4<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>dates<span class="token punctuation">,</span> features<span class="token punctuation">[</span><span class="token string">&#39;friend&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax4<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">&#39;Date&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ax4<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">&#39;Temperature&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ax4<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">&#39;Friend Estimate&#39;</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span>pad<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 独热编码</span>
features <span class="token operator">=</span> pd<span class="token punctuation">.</span>get_dummies<span class="token punctuation">(</span>features<span class="token punctuation">)</span>
features<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># 标签</span>
labels <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>features<span class="token punctuation">[</span><span class="token string">&#39;actual&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 在特征中去掉标签</span>
features<span class="token operator">=</span> features<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token string">&#39;actual&#39;</span><span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 名字单独保存一下，以备后患</span>
feature_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>

<span class="token comment"># 转换成合适的格式</span>
features <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>features<span class="token punctuation">)</span>


features<span class="token punctuation">.</span>shape
<span class="token punctuation">(</span><span class="token number">348</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span>

<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> preprocessing
input_features <span class="token operator">=</span> preprocessing<span class="token punctuation">.</span>StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>features<span class="token punctuation">)</span>
</code></pre></div><h3 id="_1-构建网络模型"><a class="header-anchor" href="#_1-构建网络模型" aria-hidden="true">#</a> 1 构建网络模型</h3><div class="language-python"><pre><code>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>input_features<span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">)</span>

y <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">)</span>

<span class="token comment"># 权重参数初始化</span>
weights <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> 
biases <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> 
weights2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> 
biases2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> 

learning_rate <span class="token operator">=</span> <span class="token number">0.001</span> 
losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 计算隐层</span>
    hidden <span class="token operator">=</span> x<span class="token punctuation">.</span>mm<span class="token punctuation">(</span>weights<span class="token punctuation">)</span> <span class="token operator">+</span> biases
    <span class="token comment"># 加入激活函数</span>
    hidden <span class="token operator">=</span>  <span class="token punctuation">.</span>relu<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
    <span class="token comment"># 预测结果</span>
    predictions <span class="token operator">=</span> hidden<span class="token punctuation">.</span>mm<span class="token punctuation">(</span>weights2<span class="token punctuation">)</span> <span class="token operator">+</span> biases2
    <span class="token comment"># 通计算损失</span>
    loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">(</span>predictions <span class="token operator">-</span> y<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> 
    losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 打印损失值</span>
    <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;loss:&#39;</span><span class="token punctuation">,</span> loss<span class="token punctuation">)</span>
    <span class="token comment">#返向传播计算</span>
    loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">#更新参数</span>
    weights<span class="token punctuation">.</span>data<span class="token punctuation">.</span>add_<span class="token punctuation">(</span><span class="token operator">-</span> learning_rate <span class="token operator">*</span> weights<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">)</span>  
    biases<span class="token punctuation">.</span>data<span class="token punctuation">.</span>add_<span class="token punctuation">(</span><span class="token operator">-</span> learning_rate <span class="token operator">*</span> biases<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    weights2<span class="token punctuation">.</span>data<span class="token punctuation">.</span>add_<span class="token punctuation">(</span><span class="token operator">-</span> learning_rate <span class="token operator">*</span> weights2<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    biases2<span class="token punctuation">.</span>data<span class="token punctuation">.</span>add_<span class="token punctuation">(</span><span class="token operator">-</span> learning_rate <span class="token operator">*</span> biases2<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    
    <span class="token comment"># 每次迭代都得记得清空</span>
    weights<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span>
    biases<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span>
    weights2<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span>
    biases2<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span>

predictions<span class="token punctuation">.</span>shape
torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">348</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-更简单的构建网络模型"><a class="header-anchor" href="#_2-更简单的构建网络模型" aria-hidden="true">#</a> 2 更简单的构建网络模型</h3><div class="language-python"><pre><code>input_size <span class="token operator">=</span> input_features<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
hidden_size <span class="token operator">=</span> <span class="token number">128</span>
output_size <span class="token operator">=</span> <span class="token number">1</span>
batch_size <span class="token operator">=</span> <span class="token number">16</span>
my_nn <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
    torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
    torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_size<span class="token punctuation">,</span> output_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment"># 损失函数</span>
cost <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">&#39;mean&#39;</span><span class="token punctuation">)</span>
<span class="token comment"># adam 论文引文第一 </span>
optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>my_nn<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr <span class="token operator">=</span> <span class="token number">0.001</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 训练网络</span>
losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    batch_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># MINI-Batch方法来进行训练    batch_size间隔</span>
    <span class="token keyword">for</span> start <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>input_features<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        end <span class="token operator">=</span> start <span class="token operator">+</span> batch_size <span class="token keyword">if</span> start <span class="token operator">+</span> batch_size <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>input_features<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token builtin">len</span><span class="token punctuation">(</span>input_features<span class="token punctuation">)</span>
        xx <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>input_features<span class="token punctuation">[</span>start<span class="token punctuation">:</span>end<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        yy <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>labels<span class="token punctuation">[</span>start<span class="token punctuation">:</span>end<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        prediction <span class="token operator">=</span> my_nn<span class="token punctuation">(</span>xx<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> cost<span class="token punctuation">(</span>prediction<span class="token punctuation">,</span> yy<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span>retain_graph<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        batch_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 打印损失</span>
    <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">100</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
        losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>batch_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>batch_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>input_features<span class="token punctuation">,</span> dtype <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
predict <span class="token operator">=</span> my_nn<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 转换日期格式</span>
dates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;-&#39;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>month<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;-&#39;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> months<span class="token punctuation">,</span> days<span class="token punctuation">)</span><span class="token punctuation">]</span>
dates <span class="token operator">=</span> <span class="token punctuation">[</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">&#39;%Y-%m-%d&#39;</span><span class="token punctuation">)</span> <span class="token keyword">for</span> date <span class="token keyword">in</span> dates<span class="token punctuation">]</span>

<span class="token comment"># 创建一个表格来存日期和其对应的标签数值</span>
true_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;date&#39;</span><span class="token punctuation">:</span> dates<span class="token punctuation">,</span> <span class="token string">&#39;actual&#39;</span><span class="token punctuation">:</span> labels<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># 同理，再创建一个来存日期和其对应的模型预测值</span>
months <span class="token operator">=</span> features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> feature_list<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">&#39;month&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
days <span class="token operator">=</span> features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> feature_list<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">&#39;day&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
years <span class="token operator">=</span> features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> feature_list<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">&#39;year&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

test_dates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;-&#39;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>month<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;-&#39;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>years<span class="token punctuation">,</span> months<span class="token punctuation">,</span> days<span class="token punctuation">)</span><span class="token punctuation">]</span>
 
test_dates <span class="token operator">=</span> <span class="token punctuation">[</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">&#39;%Y-%m-%d&#39;</span><span class="token punctuation">)</span> <span class="token keyword">for</span> date <span class="token keyword">in</span> test_dates<span class="token punctuation">]</span>

predictions_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;date&#39;</span><span class="token punctuation">:</span> test_dates<span class="token punctuation">,</span> <span class="token string">&#39;prediction&#39;</span><span class="token punctuation">:</span> predict<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 真实值</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>true_data<span class="token punctuation">[</span><span class="token string">&#39;date&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> true_data<span class="token punctuation">[</span><span class="token string">&#39;actual&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&#39;b-&#39;</span><span class="token punctuation">,</span> label <span class="token operator">=</span> <span class="token string">&#39;actual&#39;</span><span class="token punctuation">)</span>

<span class="token comment"># 预测值</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>predictions_data<span class="token punctuation">[</span><span class="token string">&#39;date&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> predictions_data<span class="token punctuation">[</span><span class="token string">&#39;prediction&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&#39;ro&#39;</span><span class="token punctuation">,</span> label <span class="token operator">=</span> <span class="token string">&#39;prediction&#39;</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span>rotation <span class="token operator">=</span> <span class="token string">&#39;60&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 图名</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">&#39;Date&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">&#39;Maximum Temperature (F)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">&#39;Actual and Predicted Values&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-卷积神将网络参数解读"><a class="header-anchor" href="#_3-卷积神将网络参数解读" aria-hidden="true">#</a> 3. 卷积神将网络参数解读</h2><h3 id="_1-构建卷积神经网络"><a class="header-anchor" href="#_1-构建卷积神经网络" aria-hidden="true">#</a> 1 构建卷积神经网络</h3><div class="language-python"><pre><code><span class="token comment"># 卷积网络中的输入和层与传统神经网络有些区别，需重新设计，训练模块基本一致</span>
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets<span class="token punctuation">,</span>transforms 
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token operator">%</span>matplotlib inline
</code></pre></div><h3 id="_2-首先读取数据"><a class="header-anchor" href="#_2-首先读取数据" aria-hidden="true">#</a> 2 首先读取数据</h3><div class="language-python"><pre><code><span class="token comment"># 分别构建训练集和测试集（验证集）</span>
<span class="token comment"># DataLoader来迭代取数据</span>

<span class="token comment"># 定义超参数 </span>
input_size <span class="token operator">=</span> <span class="token number">28</span>  <span class="token comment">#图像的总尺寸28*28</span>
num_classes <span class="token operator">=</span> <span class="token number">10</span>  <span class="token comment">#标签的种类数</span>
num_epochs <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment">#训练的总循环周期</span>
batch_size <span class="token operator">=</span> <span class="token number">64</span>  <span class="token comment">#一个撮（批次）的大小，64张图片</span>

<span class="token comment"># 训练集</span>
train_dataset <span class="token operator">=</span> datasets<span class="token punctuation">.</span>MNIST<span class="token punctuation">(</span>root<span class="token operator">=</span><span class="token string">&#39;./data&#39;</span><span class="token punctuation">,</span>  
                            train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>   
                            transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
                            download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> 

<span class="token comment"># 测试集</span>
test_dataset <span class="token operator">=</span> datasets<span class="token punctuation">.</span>MNIST<span class="token punctuation">(</span>root<span class="token operator">=</span><span class="token string">&#39;./data&#39;</span><span class="token punctuation">,</span> 
                           train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
                           transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 构建batch数据</span>
train_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span> 
                                           batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> 
                                           shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>test_dataset<span class="token punctuation">,</span> 
                                           batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> 
                                           shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_3-卷积网络模块构建"><a class="header-anchor" href="#_3-卷积网络模块构建" aria-hidden="true">#</a> 3 卷积网络模块构建</h3><div class="language-python"><pre><code><span class="token comment"># 一般卷积层，relu层，池化层可以写成一个套餐</span>
<span class="token comment"># 注意卷积最后结果还是一个特征图，需要把图转换成向量才能做分类或者回归任务</span>
<span class="token keyword">class</span> <span class="token class-name">CNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>         <span class="token comment"># 输入大小 (1, 28, 28)</span>
            <span class="token comment"># 2d的卷积做任务   图像    3d的话就是视频数据</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
                in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>              <span class="token comment"># 灰度图</span>
                out_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>            <span class="token comment"># 要得到几多少个特征图  卷积核的个数</span>
                kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>              <span class="token comment"># 卷积核大小 5*5</span>
                stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>                   <span class="token comment"># 步长 </span>
                padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>                  <span class="token comment"># 如果希望卷积后大小跟原来一样，需要设置padding=(kernel_size-1)/2 if stride=1</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>                              <span class="token comment"># 输出的特征图为 (16, 28, 28)</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                      <span class="token comment"># relu层</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># 进行池化操作（2x2 区域）, 输出结果为： (16, 14, 14) 压缩完为原来的一半</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>         <span class="token comment"># 下一个套餐的输入 (16, 14, 14)</span>
            <span class="token comment"># 输出 16  需要32个特征</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment"># 输出 (32, 14, 14) </span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                      <span class="token comment"># relu层</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment"># 输出 (32, 7, 7)</span>
        <span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>         <span class="token comment"># 下一个套餐的输入 (16, 14, 14)</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment"># 输出 (32, 14, 14)</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment"># 输出 (64, 7, 7)</span>
        <span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>out <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>   <span class="token comment"># 全连接层得到的结果</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 前向传播</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment"># x有4个维度   bactch,c,h,w</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># view = reshape   （bactch不变,特征个数） 四维变成二维矩阵</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>           <span class="token comment"># flatten操作，结果为：(batch_size, 32 * 7 * 7)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>out<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output
</code></pre></div><h3 id="_4-准确率作为评估标准"><a class="header-anchor" href="#_4-准确率作为评估标准" aria-hidden="true">#</a> 4 准确率作为评估标准</h3><div class="language-python"><pre><code><span class="token keyword">def</span> <span class="token function">accuracy</span><span class="token punctuation">(</span>predictions<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># torch.max有两个返回值  [0]最大值  [1]索引</span>
    pred <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>predictions<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 
    rights <span class="token operator">=</span> pred<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>labels<span class="token punctuation">.</span>data<span class="token punctuation">.</span>view_as<span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> rights<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
</code></pre></div><h3 id="_5-训练网络模型"><a class="header-anchor" href="#_5-训练网络模型" aria-hidden="true">#</a> 5 训练网络模型</h3><div class="language-python"><pre><code><span class="token comment"># 实例化</span>
net <span class="token operator">=</span> CNN<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">#损失函数</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">#优化器</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span> <span class="token comment">#定义优化器，普通的随机梯度下降算法</span>

<span class="token comment">#开始训练循环</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#当前epoch的结果保存下来</span>
    train_rights <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> 
    
    <span class="token keyword">for</span> batch_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#针对容器中的每一个批进行循环</span>
        net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>                             
        output <span class="token operator">=</span> net<span class="token punctuation">(</span>data<span class="token punctuation">)</span> 
        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">)</span> 
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> 
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span> 
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span> 
        right <span class="token operator">=</span> accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">)</span> 
        train_rights<span class="token punctuation">.</span>append<span class="token punctuation">(</span>right<span class="token punctuation">)</span> 

    
        <span class="token keyword">if</span> batch_idx <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> 
            
            net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            val_rights <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> 
            
            <span class="token keyword">for</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token keyword">in</span> test_loader<span class="token punctuation">:</span>
                output <span class="token operator">=</span> net<span class="token punctuation">(</span>data<span class="token punctuation">)</span> 
                right <span class="token operator">=</span> accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">)</span> 
                val_rights<span class="token punctuation">.</span>append<span class="token punctuation">(</span>right<span class="token punctuation">)</span>
                
            <span class="token comment">#准确率计算</span>
            train_r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tup<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> tup <span class="token keyword">in</span> train_rights<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tup<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> tup <span class="token keyword">in</span> train_rights<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            val_r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tup<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> tup <span class="token keyword">in</span> val_rights<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tup<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> tup <span class="token keyword">in</span> val_rights<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;当前epoch: {} [{}/{} ({:.0f}%)]\t损失: {:.6f}\t训练集准确率: {:.2f}%\t测试集正确率: {:.2f}%&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                epoch<span class="token punctuation">,</span> batch_idx <span class="token operator">*</span> batch_size<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">100</span><span class="token punctuation">.</span> <span class="token operator">*</span> batch_idx <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                loss<span class="token punctuation">.</span>data<span class="token punctuation">,</span> 
                <span class="token number">100</span><span class="token punctuation">.</span> <span class="token operator">*</span> train_r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> train_r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token number">100</span><span class="token punctuation">.</span> <span class="token operator">*</span> val_r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> val_r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-"><pre><code>当前epoch: 2 [25600/60000 (43%)]	损失: 0.018130	训练集准确率: 99.16%	测试集正确率: 99.09%
当前epoch: 2 [32000/60000 (53%)]	损失: 0.006968	训练集准确率: 99.15%	测试集正确率: 99.11%
</code></pre></div><h2 id="_4-图像识别模型与训练策略"><a class="header-anchor" href="#_4-图像识别模型与训练策略" aria-hidden="true">#</a> 4. 图像识别模型与训练策略</h2><h3 id="_1-0-1-数据预处理部分："><a class="header-anchor" href="#_1-0-1-数据预处理部分：" aria-hidden="true">#</a> 1.0.1 数据预处理部分：</h3><ul><li>数据增强：torchvision中transforms模块自带功能，比较实用</li><li>数据预处理：torchvision中transforms也帮我们实现好了，直接调用即可</li><li>DataLoader模块直接读取batch数据</li></ul><h3 id="_1-0-2-网络模块设置："><a class="header-anchor" href="#_1-0-2-网络模块设置：" aria-hidden="true">#</a> 1.0.2 网络模块设置：</h3><ul><li>加载预训练模型，torchvision中有很多经典网络架构，调用起来十分方便，并且可以用人家训练好的权重参数来继续训练，也就是所谓的迁移学习</li><li>需要注意的是别人训练好的任务跟咱们的可不是完全一样，需要把最后的head层改一改，一般也就是最后的全连接层，改成咱们自己的任务</li><li>训练时可以全部重头训练，也可以只训练最后咱们任务的层，因为前几层都是做特征提取的，本质任务目标是一致的</li></ul><h3 id="_1-0-3-网络模型保存与测试"><a class="header-anchor" href="#_1-0-3-网络模型保存与测试" aria-hidden="true">#</a> 1.0.3 网络模型保存与测试</h3><ul><li>模型保存的时候可以带有选择性，例如在验证集中如果当前效果好则保存</li><li>读取模型进行实际测试</li></ul><div class="language-python"><pre><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token operator">%</span>matplotlib inline
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">import</span> torchvision
<span class="token comment">#pip install torchvision</span>
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms<span class="token punctuation">,</span> models<span class="token punctuation">,</span> datasets
<span class="token comment">#https://pytorch.org/docs/stable/torchvision/index.html</span>
<span class="token keyword">import</span> imageio
<span class="token keyword">import</span> time
<span class="token keyword">import</span> warnings
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">&quot;ignore&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> random
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> copy
<span class="token keyword">import</span> json
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
</code></pre></div><h3 id="_1-0-4-数据读取与预处理操作"><a class="header-anchor" href="#_1-0-4-数据读取与预处理操作" aria-hidden="true">#</a> 1.0.4 数据读取与预处理操作</h3><div class="language-python"><pre><code>data_dir <span class="token operator">=</span> <span class="token string">&#39;./flower_data/&#39;</span>
train_dir <span class="token operator">=</span> data_dir <span class="token operator">+</span> <span class="token string">&#39;/train&#39;</span>
valid_dir <span class="token operator">=</span> data_dir <span class="token operator">+</span> <span class="token string">&#39;/valid&#39;</span>
</code></pre></div><h3 id="_1-0-5-制作好数据源："><a class="header-anchor" href="#_1-0-5-制作好数据源：" aria-hidden="true">#</a> 1.0.5 制作好数据源：</h3><ul><li>data_transforms中指定了所有图像预处理操作</li><li>ImageFolder假设所有的文件按文件夹保存好，每个文件夹下面存贮同一类别的图片，文件夹的名字为分类的名字</li></ul><div class="language-python"><pre><code>data_transforms <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span> 
        transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#随机旋转，-45到45度之间随机选  数据增强</span>
        transforms<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#从中心开始裁剪</span>
        transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#随机水平翻转 选择一个概率概率</span>
        transforms<span class="token punctuation">.</span>RandomVerticalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#随机垂直翻转</span>
        transforms<span class="token punctuation">.</span>ColorJitter<span class="token punctuation">(</span>brightness<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> contrast<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> saturation<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#参数1为亮度，参数2为对比度，参数3为饱和度，参数4为色相</span>
        transforms<span class="token punctuation">.</span>RandomGrayscale<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.025</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#概率转换成灰度率，3通道就是R=G=B</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 转化为torch支持的数据结构</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#均值，标准差</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&#39;valid&#39;</span><span class="token punctuation">:</span> 
        transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

batch_size <span class="token operator">=</span> <span class="token number">128</span> 

image_datasets <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> data_transforms<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;valid&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
dataloaders <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>image_datasets<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;valid&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
dataset_sizes <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_datasets<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;valid&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
class_names <span class="token operator">=</span> image_datasets<span class="token punctuation">[</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>classes
</code></pre></div><div class="language-python"><pre><code>image_datasets

dataloaders
<span class="token punctuation">{</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataloader<span class="token punctuation">.</span>DataLoader at <span class="token number">0x1e4c50b9400</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
 <span class="token string">&#39;valid&#39;</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataloader<span class="token punctuation">.</span>DataLoader at <span class="token number">0x1e4c51ad128</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>

dataset_sizes
<span class="token punctuation">{</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span> <span class="token number">6552</span><span class="token punctuation">,</span> <span class="token string">&#39;valid&#39;</span><span class="token punctuation">:</span> <span class="token number">818</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-0-6-读取标签对应的实际名字"><a class="header-anchor" href="#_1-0-6-读取标签对应的实际名字" aria-hidden="true">#</a> 1.0.6 读取标签对应的实际名字</h3><div class="language-python"><pre><code><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#39;cat_to_name.json&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    cat_to_name <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

cat_to_name
<span class="token punctuation">{</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;pink primrose&#39;</span><span class="token punctuation">,</span>
 <span class="token string">&#39;10&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;globe thistle&#39;</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="_1-0-7-加载models中提供的模型"><a class="header-anchor" href="#_1-0-7-加载models中提供的模型" aria-hidden="true">#</a> 1.0.7 加载models中提供的模型</h3><p>并且直接用训练的好权重当做初始化参数</p><ul><li>第一次执行需要下载，可能会比较慢，我会提供给大家一份下载好的，可以直接放到相应路径</li></ul><div class="language-python"><pre><code>model_name <span class="token operator">=</span> <span class="token string">&#39;resnet&#39;</span>  <span class="token comment">#可选的比较多 [&#39;resnet&#39;, &#39;alexnet&#39;, &#39;vgg&#39;, &#39;squeezenet&#39;, &#39;densenet&#39;, &#39;inception&#39;]</span>
<span class="token comment">#是否用人家训练好的特征来做</span>
feature_extract <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token comment">#都用人家特征，咱先不更新</span>
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 是否用GPU训练</span>
train_on_gpu <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> train_on_gpu<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;CUDA is not available.  Training on CPU ...&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;CUDA is available!  Training on GPU ...&#39;</span><span class="token punctuation">)</span>
    
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">&quot;cuda:0&quot;</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">&quot;cpu&quot;</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 有时候用人家模型，就一直用了，更不更新咱们可以自己定</span>
<span class="token keyword">def</span> <span class="token function">set_parameter_requires_grad</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> feature_extracting<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> feature_extracting<span class="token punctuation">:</span>
        <span class="token keyword">for</span> param <span class="token keyword">in</span> model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 反向传播的时候不计算梯度</span>
            
model_ft <span class="token operator">=</span> models<span class="token punctuation">.</span>resnet18<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#18层的能快点，条件好点的也可以选152</span>
model_ft
</code></pre></div><h3 id="_1-0-8-把模型输出层改成自己的"><a class="header-anchor" href="#_1-0-8-把模型输出层改成自己的" aria-hidden="true">#</a> 1.0.8 把模型输出层改成自己的</h3><div class="language-python"><pre><code><span class="token keyword">def</span> <span class="token function">initialize_model</span><span class="token punctuation">(</span>model_name<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> feature_extract<span class="token punctuation">,</span> use_pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    model_ft <span class="token operator">=</span> models<span class="token punctuation">.</span>resnet18<span class="token punctuation">(</span>pretrained<span class="token operator">=</span>use_pretrained<span class="token punctuation">)</span> <span class="token comment"># use_pretrained 别人训练好的参数 </span>
    set_parameter_requires_grad<span class="token punctuation">(</span>model_ft<span class="token punctuation">,</span> feature_extract<span class="token punctuation">)</span>
    
    num_ftrs <span class="token operator">=</span> model_ft<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>in_features
    model_ft<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_ftrs<span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">)</span><span class="token comment">#类别数自己根据自己任务来 102个类别</span>
                            
    input_size <span class="token operator">=</span> <span class="token number">64</span><span class="token comment">#输入大小根据自己配置来</span>

    <span class="token keyword">return</span> model_ft<span class="token punctuation">,</span> input_size
</code></pre></div><h3 id="_1-0-9-设置哪些层需要训练"><a class="header-anchor" href="#_1-0-9-设置哪些层需要训练" aria-hidden="true">#</a> 1.0.9 设置哪些层需要训练</h3><div class="language-python"><pre><code>
model_ft<span class="token punctuation">,</span> input_size <span class="token operator">=</span> initialize_model<span class="token punctuation">(</span>model_name<span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> feature_extract<span class="token punctuation">,</span> use_pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment">#GPU还是CPU计算</span>
model_ft <span class="token operator">=</span> model_ft<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

<span class="token comment"># 模型保存，名字自己起</span>
filename<span class="token operator">=</span><span class="token string">&#39;checkpoint.pth&#39;</span>

<span class="token comment"># 是否训练所有层</span>
params_to_update <span class="token operator">=</span> model_ft<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Params to learn:&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> feature_extract<span class="token punctuation">:</span>
    params_to_update <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> name<span class="token punctuation">,</span>param <span class="token keyword">in</span> model_ft<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> param<span class="token punctuation">.</span>requires_grad <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            params_to_update<span class="token punctuation">.</span>append<span class="token punctuation">(</span>param<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\t&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> name<span class="token punctuation">,</span>param <span class="token keyword">in</span> model_ft<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> param<span class="token punctuation">.</span>requires_grad <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\t&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
Params to learn<span class="token punctuation">:</span>
	 fc<span class="token punctuation">.</span>weight
	 fc<span class="token punctuation">.</span>bias
</code></pre></div><h3 id="_1-0-10-优化器设置"><a class="header-anchor" href="#_1-0-10-优化器设置" aria-hidden="true">#</a> 1.0.10 优化器设置</h3><div class="language-python"><pre><code><span class="token comment"># 优化器设置</span>
optimizer_ft <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>params_to_update<span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment">#要训练啥参数，你来定</span>
scheduler <span class="token operator">=</span> optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer_ft<span class="token punctuation">,</span> step_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token comment">#学习率每7个epoch衰减成原来的1/10</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_1-0-11-训练模块"><a class="header-anchor" href="#_1-0-11-训练模块" aria-hidden="true">#</a> 1.0.11 训练模块</h3><div class="language-python"><pre><code><span class="token keyword">def</span> <span class="token function">train_model</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> dataloaders<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">,</span>filename<span class="token operator">=</span><span class="token string">&#39;best.pt&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#咱们要算时间的</span>
    since <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#也要记录最好的那一次</span>
    best_acc <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">#模型也得放到你的CPU或者GPU</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    <span class="token comment">#训练过程中打印一堆损失和指标</span>
    val_acc_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    train_acc_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    train_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    valid_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">#学习率</span>
    LRs <span class="token operator">=</span> <span class="token punctuation">[</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;lr&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token comment">#最好的那次模型，后续会变的，先初始化</span>
    best_model_wts <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#一个个epoch来遍历</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Epoch {}/{}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> num_epochs <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;-&#39;</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>

        <span class="token comment"># 训练和验证</span>
        <span class="token keyword">for</span> phase <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;valid&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span>
                model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 训练</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 验证</span>

            running_loss <span class="token operator">=</span> <span class="token number">0.0</span>
            running_corrects <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token comment"># 把数据都取个遍</span>
            <span class="token keyword">for</span> inputs<span class="token punctuation">,</span> labels <span class="token keyword">in</span> dataloaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">:</span>
                inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token comment">#放到你的CPU或GPU</span>
                labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

                <span class="token comment"># 清零</span>
                optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 只有训练的时候计算和更新梯度</span>
                outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
                loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                _<span class="token punctuation">,</span> preds <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token comment"># 训练阶段更新权重</span>
                <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span>
                    loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token comment"># 计算损失</span>
                running_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> inputs<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#0表示batch那个维度</span>
                running_corrects <span class="token operator">+=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>preds <span class="token operator">==</span> labels<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token comment">#预测结果最大的和真实值是否一致</span>
                
            
            
            epoch_loss <span class="token operator">=</span> running_loss <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset<span class="token punctuation">)</span><span class="token comment">#算平均</span>
            epoch_acc <span class="token operator">=</span> running_corrects<span class="token punctuation">.</span>double<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
            
            time_elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> since<span class="token comment">#一个epoch我浪费了多少时间</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Time elapsed {:.0f}m {:.0f}s&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time_elapsed <span class="token operator">//</span> <span class="token number">60</span><span class="token punctuation">,</span> time_elapsed <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;{} Loss: {:.4f} Acc: {:.4f}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>phase<span class="token punctuation">,</span> epoch_loss<span class="token punctuation">,</span> epoch_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
            

            <span class="token comment"># 得到最好那次的模型</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;valid&#39;</span> <span class="token keyword">and</span> epoch_acc <span class="token operator">&gt;</span> best_acc<span class="token punctuation">:</span>
                best_acc <span class="token operator">=</span> epoch_acc
                best_model_wts <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                state <span class="token operator">=</span> <span class="token punctuation">{</span>
                  <span class="token string">&#39;state_dict&#39;</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#字典里key就是各层的名字，值就是训练好的权重</span>
                  <span class="token string">&#39;best_acc&#39;</span><span class="token punctuation">:</span> best_acc<span class="token punctuation">,</span>
                  <span class="token string">&#39;optimizer&#39;</span> <span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
                torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>state<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;valid&#39;</span><span class="token punctuation">:</span>
                val_acc_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_acc<span class="token punctuation">)</span>
                valid_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span>
                <span class="token comment">#scheduler.step(epoch_loss)#学习率衰减</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span>
                train_acc_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_acc<span class="token punctuation">)</span>
                train_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Optimizer learning rate : {:.7f}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;lr&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        LRs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;lr&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#学习率衰减</span>

    time_elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> since
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Training complete in {:.0f}m {:.0f}s&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time_elapsed <span class="token operator">//</span> <span class="token number">60</span><span class="token punctuation">,</span> time_elapsed <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Best val Acc: {:4f}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>best_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 训练完后用最好的一次当做模型最终的结果,等着一会测试</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>best_model_wts<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model<span class="token punctuation">,</span> val_acc_history<span class="token punctuation">,</span> train_acc_history<span class="token punctuation">,</span> valid_losses<span class="token punctuation">,</span> train_losses<span class="token punctuation">,</span> LRs 
</code></pre></div><h3 id="_1-0-12-开始训练"><a class="header-anchor" href="#_1-0-12-开始训练" aria-hidden="true">#</a> 1.0.12 开始训练</h3><div class="language-python"><pre><code>model_ft<span class="token punctuation">,</span> val_acc_history<span class="token punctuation">,</span> train_acc_history<span class="token punctuation">,</span> valid_losses<span class="token punctuation">,</span> train_losses<span class="token punctuation">,</span> LRs  <span class="token operator">=</span> train_model<span class="token punctuation">(</span>model_ft<span class="token punctuation">,</span> dataloaders<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> optimizer_ft<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_1-0-13-再继续训练所有层"><a class="header-anchor" href="#_1-0-13-再继续训练所有层" aria-hidden="true">#</a> 1.0.13 再继续训练所有层</h3><div class="language-python"><pre><code><span class="token keyword">for</span> param <span class="token keyword">in</span> model_ft<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 再继续训练所有的参数，学习率调小一点</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model_ft<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
scheduler <span class="token operator">=</span> optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer_ft<span class="token punctuation">,</span> step_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>

<span class="token comment"># 损失函数</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 加载之前训练好的权重参数</span>
checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
best_acc <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">&#39;best_acc&#39;</span><span class="token punctuation">]</span>
model_ft<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">&#39;state_dict&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

model_ft<span class="token punctuation">,</span> val_acc_history<span class="token punctuation">,</span> train_acc_history<span class="token punctuation">,</span> valid_losses<span class="token punctuation">,</span> train_losses<span class="token punctuation">,</span> LRs  <span class="token operator">=</span> train_model<span class="token punctuation">(</span>model_ft<span class="token punctuation">,</span> dataloaders<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_1-0-14-加载训练好的模型"><a class="header-anchor" href="#_1-0-14-加载训练好的模型" aria-hidden="true">#</a> 1.0.14 加载训练好的模型</h3><div class="language-python"><pre><code>model_ft<span class="token punctuation">,</span> input_size <span class="token operator">=</span> initialize_model<span class="token punctuation">(</span>model_name<span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> feature_extract<span class="token punctuation">,</span> use_pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># GPU模式</span>
model_ft <span class="token operator">=</span> model_ft<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

<span class="token comment"># 保存文件的名字</span>
filename<span class="token operator">=</span><span class="token string">&#39;best.pt&#39;</span>

<span class="token comment"># 加载模型</span>
checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
best_acc <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">&#39;best_acc&#39;</span><span class="token punctuation">]</span>
model_ft<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">&#39;state_dict&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_1-0-15-测试数据预处理"><a class="header-anchor" href="#_1-0-15-测试数据预处理" aria-hidden="true">#</a> 1.0.15 测试数据预处理</h3><ul><li>测试数据处理方法需要跟训练时一直才可以</li><li>crop操作的目的是保证输入的大小是一致的</li><li>标准化操作也是必须的，用跟训练数据相同的mean和std,但是需要注意一点训练数据是在0-1上进行标准化，所以测试数据也需要先归一化</li><li>最后一点，PyTorch中颜色通道是第一个维度，跟很多工具包都不一样，需要转换</li></ul><div class="language-python"><pre><code><span class="token comment"># 得到一个batch的测试数据</span>
dataiter <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>dataloaders<span class="token punctuation">[</span><span class="token string">&#39;valid&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
images<span class="token punctuation">,</span> labels <span class="token operator">=</span> dataiter<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
model_ft<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> train_on_gpu<span class="token punctuation">:</span>
    output <span class="token operator">=</span> model_ft<span class="token punctuation">(</span>images<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> model_ft<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># output表示对一个batch中每一个数据得到其属于各个类别的可能性</span>
output<span class="token punctuation">.</span>shape
torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_1-0-16-得到概率最大的那个"><a class="header-anchor" href="#_1-0-16-得到概率最大的那个" aria-hidden="true">#</a> 1.0.16 得到概率最大的那个</h3><div class="language-python"><pre><code>_<span class="token punctuation">,</span> preds_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

preds <span class="token operator">=</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>preds_tensor<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> train_on_gpu <span class="token keyword">else</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>preds_tensor<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
preds
</code></pre></div><h3 id="_1-0-17-展示预测结果"><a class="header-anchor" href="#_1-0-17-展示预测结果" aria-hidden="true">#</a> 1.0.17 展示预测结果</h3><div class="language-python"><pre><code><span class="token keyword">def</span> <span class="token function">im_convert</span><span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot; 展示数据&quot;&quot;&quot;</span>
    image <span class="token operator">=</span> tensor<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">&quot;cpu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> image <span class="token operator">*</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> image

fig<span class="token operator">=</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
columns <span class="token operator">=</span><span class="token number">4</span>
rows <span class="token operator">=</span> <span class="token number">2</span> 

<span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span> <span class="token punctuation">(</span>columns<span class="token operator">*</span>rows<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ax <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_subplot<span class="token punctuation">(</span>rows<span class="token punctuation">,</span> columns<span class="token punctuation">,</span> idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> xticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>im_convert<span class="token punctuation">(</span>images<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">&quot;{} ({})&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>cat_to_name<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>preds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cat_to_name<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;green&quot;</span> <span class="token keyword">if</span> cat_to_name<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>preds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">==</span>cat_to_name<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_5-数据集dataloader制作"><a class="header-anchor" href="#_5-数据集dataloader制作" aria-hidden="true">#</a> 5.数据集Dataloader制作</h2><h3 id="_1-1-如何自定义数据集："><a class="header-anchor" href="#_1-1-如何自定义数据集：" aria-hidden="true">#</a> 1.1 如何自定义数据集：</h3><ul><li>1.数据和标签的目录结构先搞定(得知道到哪读数据)</li><li>2.写好读取数据和标签路径的函数(根据自己数据集情况来写)</li><li>3.完成单个数据与标签读取函数(给dataloader举一个例子)</li></ul><h3 id="_1-2-咱们以花朵数据集为例："><a class="header-anchor" href="#_1-2-咱们以花朵数据集为例：" aria-hidden="true">#</a> 1.2 咱们以花朵数据集为例：</h3><ul><li>原来数据集都是以文件夹为类别ID，现在咱们换一个套路，用txt文件指定数据路径与标签(实际情况基本都这样)</li><li>这回咱们的任务就是在txt文件中获取图像路径与标签，然后把他们交给dataloader</li><li>核心代码非常简单，按照对应格式传递需要的数据和标签就可以啦</li></ul><div class="language-python"><pre><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token operator">%</span>matplotlib inline
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">import</span> torchvision
<span class="token comment">#pip install torchvision</span>
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms<span class="token punctuation">,</span> models<span class="token punctuation">,</span> datasets
<span class="token comment">#https://pytorch.org/docs/stable/torchvision/index.html</span>
<span class="token keyword">import</span> imageio
<span class="token keyword">import</span> time
<span class="token keyword">import</span> warnings
<span class="token keyword">import</span> random
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> copy
<span class="token keyword">import</span> json
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
</code></pre></div><h3 id="_2-0-1-任务1：读取txt文件中的路径和标签"><a class="header-anchor" href="#_2-0-1-任务1：读取txt文件中的路径和标签" aria-hidden="true">#</a> 2.0.1 任务1：读取txt文件中的路径和标签</h3><ul><li>第一个小任务，从标注文件中读取数据和标签</li><li>至于你准备存成什么格式，都可以的，一会能取出来东西就行</li></ul><div class="language-python"><pre><code><span class="token keyword">def</span> <span class="token function">load_annotations</span><span class="token punctuation">(</span>ann_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data_infos <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>ann_file<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token comment"># image_06734.jpg 0</span>
        samples <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39; &#39;</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> filename<span class="token punctuation">,</span> gt_label <span class="token keyword">in</span> samples<span class="token punctuation">:</span> 
            <span class="token comment"># &#39;image_06734.jpg&#39;: array(0, dtype=int64)</span>
            data_infos<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>gt_label<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data_infos
<span class="token keyword">print</span><span class="token punctuation">(</span>load_annotations<span class="token punctuation">(</span><span class="token string">&#39;./flower_data/train.txt&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-0-2-任务2：分别把数据和标签都存在list里"><a class="header-anchor" href="#_2-0-2-任务2：分别把数据和标签都存在list里" aria-hidden="true">#</a> 2.0.2 任务2：分别把数据和标签都存在list里</h3><ul><li>不是我非让你存list里，因为dataloader到时候会在这里取数据</li><li>按照人家要求来，不要耍个性，让整list咱就给人家整</li></ul><div class="language-python"><pre><code>img_label <span class="token operator">=</span> load_annotations<span class="token punctuation">(</span><span class="token string">&#39;./flower_data/train.txt&#39;</span><span class="token punctuation">)</span>
image_name <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>img_label<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
label <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>img_label<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-0-3-任务3：图像数据路径得完整"><a class="header-anchor" href="#_2-0-3-任务3：图像数据路径得完整" aria-hidden="true">#</a> 2.0.3 任务3：图像数据路径得完整</h3><ul><li>因为一会咱得用这个路径去读数据，所以路径得加上前缀</li><li>以后大家任务不同，数据不同，怎么加你看着来就行，反正得能读到图像</li></ul><div class="language-python"><pre><code>data_dir <span class="token operator">=</span> <span class="token string">&#39;./flower_data/&#39;</span>
train_dir <span class="token operator">=</span> data_dir <span class="token operator">+</span> <span class="token string">&#39;/train_filelist&#39;</span>
valid_dir <span class="token operator">=</span> data_dir <span class="token operator">+</span> <span class="token string">&#39;/val_filelist&#39;</span>

image_path <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>train_dir<span class="token punctuation">,</span>img<span class="token punctuation">)</span> <span class="token keyword">for</span> img <span class="token keyword">in</span> image_name<span class="token punctuation">]</span>
image_path
</code></pre></div><h3 id="_2-0-4-任务4：把上面那几个事得写在一起"><a class="header-anchor" href="#_2-0-4-任务4：把上面那几个事得写在一起" aria-hidden="true">#</a> 2.0.4 任务4：把上面那几个事得写在一起</h3><ul><li>1.注意要使用from torch.utils.data import Dataset, DataLoader</li><li>2.类名定义class FlowerDataset(Dataset)，其中FlowerDataset可以改成自己的名字</li><li>3.def <strong>init</strong>(self, root_dir, ann_file, transform=None):咱们要根据自己任务重写</li><li>4.def <strong>getitem</strong>(self, idx):根据自己任务，返回图像数据和标签数据</li></ul><div class="language-python"><pre><code><span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span> DataLoader
<span class="token keyword">class</span> <span class="token class-name">FlowerDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root_dir<span class="token punctuation">,</span> ann_file<span class="token punctuation">,</span> transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ann_file <span class="token operator">=</span> ann_file <span class="token comment"># txt</span>
        self<span class="token punctuation">.</span>root_dir <span class="token operator">=</span> root_dir <span class="token comment"># 图像所在文件夹</span>
        <span class="token comment"># 字典格式的 &#39;image_06734.jpg&#39;: array(0, dtype=int64)</span>
        self<span class="token punctuation">.</span>img_label <span class="token operator">=</span> self<span class="token punctuation">.</span>load_annotations<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 图像路径</span>
        self<span class="token punctuation">.</span>img <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root_dir<span class="token punctuation">,</span>img<span class="token punctuation">)</span> <span class="token keyword">for</span> img <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_label<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>label <span class="token operator">=</span> <span class="token punctuation">[</span>label <span class="token keyword">for</span> label <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_label<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform
 
    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>img<span class="token punctuation">)</span>
 
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>img<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> self<span class="token punctuation">.</span>label<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">:</span>
            image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        label <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> label
    
    <span class="token comment"># 返回字典形式 </span>
    <span class="token keyword">def</span> <span class="token function">load_annotations</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_infos <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ann_file<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            samples <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39; &#39;</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> filename<span class="token punctuation">,</span> gt_label <span class="token keyword">in</span> samples<span class="token punctuation">:</span>
                <span class="token comment"># &#39;image_06734.jpg&#39;: array(0, dtype=int64)</span>
                data_infos<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>gt_label<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
            
        <span class="token keyword">return</span> data_infos
</code></pre></div><h3 id="_2-0-5-任务5：数据预处理-transform"><a class="header-anchor" href="#_2-0-5-任务5：数据预处理-transform" aria-hidden="true">#</a> 2.0.5 任务5：数据预处理(transform)</h3><ul><li>1.预处理的事都在上面的<strong>getitem</strong>中完成，需要对图像和标签咋咋地的，要整啥事，都在上面整</li><li>2.返回的数据和标签就是建模时模型的输入和损失函数中标签的输入，一定整明白自己模型要啥</li><li>3.预处理这个事是你定的，不同的数据需要的方法也不一样，下面给出的是比较通用的方法</li></ul><div class="language-python"><pre><code>data_transforms <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span> 
        transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#随机旋转，-45到45度之间随机选</span>
        transforms<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#从中心开始裁剪</span>
        transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#随机水平翻转 选择一个概率概率</span>
        transforms<span class="token punctuation">.</span>RandomVerticalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#随机垂直翻转</span>
        transforms<span class="token punctuation">.</span>ColorJitter<span class="token punctuation">(</span>brightness<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> contrast<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> saturation<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#参数1为亮度，参数2为对比度，参数3为饱和度，参数4为色相</span>
        transforms<span class="token punctuation">.</span>RandomGrayscale<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.025</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#概率转换成灰度率，3通道就是R=G=B</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#均值，标准差</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&#39;valid&#39;</span><span class="token punctuation">:</span> 
        transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-0-6-任务6：根据写好的class-flowerdataset-dataset-来实例化咱们的dataloader"><a class="header-anchor" href="#_2-0-6-任务6：根据写好的class-flowerdataset-dataset-来实例化咱们的dataloader" aria-hidden="true">#</a> 2.0.6 任务6：根据写好的class FlowerDataset(Dataset):来实例化咱们的dataloader</h3><ul><li>1.构建数据集：分别创建训练和验证用的数据集（如果需要测试集也一样的方法）</li><li>2.用Torch给的DataLoader方法来实例化(batch啥的自己定，根据你的显存来选合适的)</li><li>3.打印看看数据里面是不是有东西了</li></ul><div class="language-python"><pre><code>train_dataset <span class="token operator">=</span> FlowerDataset<span class="token punctuation">(</span>root_dir<span class="token operator">=</span>train_dir<span class="token punctuation">,</span> ann_file <span class="token operator">=</span> <span class="token string">&#39;./flower_data/train.txt&#39;</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>data_transforms<span class="token punctuation">[</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
val_dataset <span class="token operator">=</span> FlowerDataset<span class="token punctuation">(</span>root_dir<span class="token operator">=</span>valid_dir<span class="token punctuation">,</span> ann_file <span class="token operator">=</span> <span class="token string">&#39;./flower_data/val.txt&#39;</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>data_transforms<span class="token punctuation">[</span><span class="token string">&#39;valid&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
val_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>val_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token builtin">len</span><span class="token punctuation">(</span>train_dataset<span class="token punctuation">)</span>
<span class="token number">6552</span>
<span class="token builtin">len</span><span class="token punctuation">(</span>val_dataset<span class="token punctuation">)</span>
<span class="token number">818</span>
</code></pre></div><h3 id="_2-0-7-任务7：用之前先试试，整个数据和标签对应下，看看对不对"><a class="header-anchor" href="#_2-0-7-任务7：用之前先试试，整个数据和标签对应下，看看对不对" aria-hidden="true">#</a> 2.0.7 任务7：用之前先试试，整个数据和标签对应下，看看对不对</h3><ul><li>1.别着急往模型里传，对不对都不知道呢</li><li>2.用这个方法：iter(train_loader).next()来试试，得到的数据和标签是啥</li><li>3.看不出来就把图画出来，标签打印出来，确保自己整的数据集没啥问题</li></ul><div class="language-python"><pre><code>image<span class="token punctuation">,</span> label <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># .next()取一个batch数据</span>
sample <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 3*64*64</span>
sample <span class="token operator">=</span> sample<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 64*64*3 </span>
sample <span class="token operator">*=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span> <span class="token comment"># 标准差</span>
sample <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span> <span class="token comment"># 均值</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>sample<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Label is: {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>label<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


image<span class="token punctuation">,</span> label <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>val_loader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sample <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
sample <span class="token operator">=</span> sample<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
sample <span class="token operator">*=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span>
sample <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>sample<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Label is: {}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>label<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-0-8-任务8：咋用就是你来定了，把模型啥的整好往里面传吧"><a class="header-anchor" href="#_2-0-8-任务8：咋用就是你来定了，把模型啥的整好往里面传吧" aria-hidden="true">#</a> 2.0.8 任务8：咋用就是你来定了，把模型啥的整好往里面传吧</h3><ul><li>下面这些事之前都唠过了，按照自己习惯的方法整就得了</li></ul><div class="language-python"><pre><code>dataloaders <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span>train_loader<span class="token punctuation">,</span><span class="token string">&#39;valid&#39;</span><span class="token punctuation">:</span>val_loader<span class="token punctuation">}</span>
model_name <span class="token operator">=</span> <span class="token string">&#39;resnet&#39;</span>  <span class="token comment">#可选的比较多 [&#39;resnet&#39;, &#39;alexnet&#39;, &#39;vgg&#39;, &#39;squeezenet&#39;, &#39;densenet&#39;, &#39;inception&#39;]</span>
<span class="token comment">#是否用人家训练好的特征来做</span>
feature_extract <span class="token operator">=</span> <span class="token boolean">True</span> 
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 是否用GPU训练</span>
train_on_gpu <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> train_on_gpu<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;CUDA is not available.  Training on CPU ...&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;CUDA is available!  Training on GPU ...&#39;</span><span class="token punctuation">)</span>
    
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">&quot;cuda:0&quot;</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">&quot;cpu&quot;</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code>model_ft <span class="token operator">=</span> models<span class="token punctuation">.</span>resnet18<span class="token punctuation">(</span><span class="token punctuation">)</span>
model_ft
</code></pre></div><div class="language-python"><pre><code>num_ftrs <span class="token operator">=</span> model_ft<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>in_features
model_ft<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_ftrs<span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
input_size <span class="token operator">=</span> <span class="token number">64</span>
model_ft
</code></pre></div><div class="language-python"><pre><code><span class="token comment"># 优化器设置</span>
optimizer_ft <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model_ft<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
scheduler <span class="token operator">=</span> optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer_ft<span class="token punctuation">,</span> step_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token comment">#学习率每7个epoch衰减成原来的1/10</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python"><pre><code><span class="token keyword">def</span> <span class="token function">train_model</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> dataloaders<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">,</span> is_inception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> filename<span class="token operator">=</span><span class="token string">&#39;best.pth&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    since <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    best_acc <span class="token operator">=</span> <span class="token number">0</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    val_acc_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    train_acc_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    train_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    valid_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    LRs <span class="token operator">=</span> <span class="token punctuation">[</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;lr&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    best_model_wts <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Epoch {}/{}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> num_epochs <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;-&#39;</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>

        <span class="token comment"># 训练和验证</span>
        <span class="token keyword">for</span> phase <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&#39;train&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;valid&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span>
                model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 训练</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 验证</span>

            running_loss <span class="token operator">=</span> <span class="token number">0.0</span>
            running_corrects <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token comment"># 把数据都取个遍</span>
            <span class="token keyword">for</span> inputs<span class="token punctuation">,</span> labels <span class="token keyword">in</span> dataloaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">:</span>
                inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

                <span class="token comment"># 清零</span>
                optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 只有训练的时候计算和更新梯度</span>
                <span class="token keyword">with</span> torch<span class="token punctuation">.</span>set_grad_enabled<span class="token punctuation">(</span>phase <span class="token operator">==</span> <span class="token string">&#39;train&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
                    loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
                    _<span class="token punctuation">,</span> preds <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token comment">#print(loss)</span>

                    <span class="token comment"># 训练阶段更新权重</span>
                    <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span>
                        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token comment"># 计算损失</span>
                running_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> inputs<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                running_corrects <span class="token operator">+=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>preds <span class="token operator">==</span> labels<span class="token punctuation">.</span>data<span class="token punctuation">)</span>

            epoch_loss <span class="token operator">=</span> running_loss <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
            epoch_acc <span class="token operator">=</span> running_corrects<span class="token punctuation">.</span>double<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
            
            
            time_elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> since
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Time elapsed {:.0f}m {:.0f}s&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time_elapsed <span class="token operator">//</span> <span class="token number">60</span><span class="token punctuation">,</span> time_elapsed <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;{} Loss: {:.4f} Acc: {:.4f}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>phase<span class="token punctuation">,</span> epoch_loss<span class="token punctuation">,</span> epoch_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
            

            <span class="token comment"># 得到最好那次的模型</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;valid&#39;</span> <span class="token keyword">and</span> epoch_acc <span class="token operator">&gt;</span> best_acc<span class="token punctuation">:</span>
                best_acc <span class="token operator">=</span> epoch_acc
                best_model_wts <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                state <span class="token operator">=</span> <span class="token punctuation">{</span>
                  <span class="token string">&#39;state_dict&#39;</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#字典里key就是各层的名字，值就是训练好的权重</span>
                  <span class="token string">&#39;best_acc&#39;</span><span class="token punctuation">:</span> best_acc<span class="token punctuation">,</span>
                  <span class="token string">&#39;optimizer&#39;</span> <span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#优化器的状态信息</span>
                <span class="token punctuation">}</span>
                torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>state<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;valid&#39;</span><span class="token punctuation">:</span>
                val_acc_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_acc<span class="token punctuation">)</span>
                valid_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span>
                scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span><span class="token comment">#学习率衰减</span>
            <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">&#39;train&#39;</span><span class="token punctuation">:</span>
                train_acc_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_acc<span class="token punctuation">)</span>
                train_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Optimizer learning rate : {:.7f}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;lr&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        LRs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;lr&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    time_elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> since
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Training complete in {:.0f}m {:.0f}s&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time_elapsed <span class="token operator">//</span> <span class="token number">60</span><span class="token punctuation">,</span> time_elapsed <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;Best val Acc: {:4f}&#39;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>best_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 训练完后用最好的一次当做模型最终的结果,等着一会测试</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>best_model_wts<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model<span class="token punctuation">,</span> val_acc_history<span class="token punctuation">,</span> train_acc_history<span class="token punctuation">,</span> valid_losses<span class="token punctuation">,</span> train_losses<span class="token punctuation">,</span> LRs 
</code></pre></div><div class="language-python"><pre><code>model_ft<span class="token punctuation">,</span> val_acc_history<span class="token punctuation">,</span> train_acc_history<span class="token punctuation">,</span> valid_losses<span class="token punctuation">,</span> train_losses<span class="token punctuation">,</span> LRs  <span class="token operator">=</span> train_model<span class="token punctuation">(</span>model_ft<span class="token punctuation">,</span> dataloaders<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> optimizer_ft<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> filename<span class="token operator">=</span><span class="token string">&#39;best.pth&#39;</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_6-lstm文本分类实战"><a class="header-anchor" href="#_6-lstm文本分类实战" aria-hidden="true">#</a> 6. LSTM文本分类实战</h2><p>见pycharm</p><h2 id="_7-flask部署"><a class="header-anchor" href="#_7-flask部署" aria-hidden="true">#</a> 7. flask部署</h2><p>见pycharm 测试成功</p></div></div><footer class="page-footer" data-v-4c107763 data-v-ddc19c16><div class="edit" data-v-ddc19c16><div class="edit-link" data-v-ddc19c16 data-v-5c10c4bc><a class="link" href="https://github.com/jekip/naive-ui-admin-docs/edit/main/note/deep_learning/3_pytorh.md" target="_blank" rel="noopener noreferrer" data-v-5c10c4bc>为此页提供修改建议 <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-5c10c4bc><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-ddc19c16><!----></div></footer><div class="next-and-prev-link" data-v-4c107763 data-v-0002a634><div class="container" data-v-0002a634><div class="prev" data-v-0002a634><!----></div><div class="next" data-v-0002a634><a class="link" href="/note/deep_learning/4_MMLab" data-v-0002a634><span class="text" data-v-0002a634>2_mmlab</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-0002a634><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"b7f8844e\",\"readme.md\":\"397ab701\",\"guide_index.md\":\"aed05413\",\"guide_introduction.md\":\"d64377a2\",\"intresting_ai_talk.md\":\"4c201715\",\"intresting_chatgpt.md\":\"15826409\",\"intresting_project.md\":\"5b28ff11\",\"other_donate.md\":\"bb2c2c78\",\"other_see.md\":\"e92e5aa7\",\"project_index.md\":\"47a50fdf\",\"note_deep_learning_3_pytorh.md\":\"a838a1da\",\"note_deep_learning_4_mmlab.md\":\"72cb2a6a\",\"note_machine_learning_03_machine_base.md\":\"73e97980\",\"note_python_01_python_base.md\":\"0805cceb\"}")</script>
    <script type="module" async src="/assets/app.a88d1aa8.js"></script>
  </body>
</html>